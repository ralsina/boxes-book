<!DOCTYPE HTML>
<html lang="en" class="sidebar-visible">
    <head>
        <!-- Book generated using mdBook -->
        <meta charset="UTF-8">
        <title>Lesson 10 - BOXES (WIP title)</title>
        <meta content="text/html; charset=utf-8" http-equiv="Content-Type">
        <meta name="description" content="The whole lifecycle of a project.">
        <meta name="viewport" content="width=device-width, initial-scale=1">
        <meta name="theme-color" content="#ffffff" />

        <base href="">

        <link rel="stylesheet" href="book.css">
        <link href="https://fonts.googleapis.com/css?family=Open+Sans:300italic,400italic,600italic,700italic,800italic,400,300,600,700,800" rel="stylesheet" type="text/css">
        <link href="https://fonts.googleapis.com/css?family=Source+Code+Pro:500" rel="stylesheet" type="text/css">

        <link rel="shortcut icon" href="favicon.png">

        <!-- Font Awesome -->
        <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.3.0/css/font-awesome.min.css">

        <link rel="stylesheet" href="highlight.css">
        <link rel="stylesheet" href="tomorrow-night.css">
        <link rel="stylesheet" href="ayu-highlight.css">

        <!-- Custom theme -->
        
        <link rel="stylesheet" href="custom.css">
        

        

        <!-- Fetch Clipboard.js from CDN but have a local fallback -->
        <script src="https://cdn.jsdelivr.net/clipboard.js/1.6.1/clipboard.min.js"></script>
        <script>
            if (typeof Clipboard == 'undefined') {
                document.write(unescape("%3Cscript src='clipboard.min.js'%3E%3C/script%3E"));
            }
        </script>

        <noscript>
            <style type="text/css">
                .javascript-only {
                    display: none;
                }
            </style>
        </noscript>

    </head>
    <body class="light">
        <!-- Work around some values being stored in localStorage wrapped in quotes -->
        <script type="text/javascript">
            try {
                var theme = localStorage.getItem('mdbook-theme');
                var sidebar = localStorage.getItem('mdbook-sidebar');

                if (theme.startsWith('"') && theme.endsWith('"')) {
                    localStorage.setItem('mdbook-theme', theme.slice(1, theme.length - 1));
                }

                if (sidebar.startsWith('"') && sidebar.endsWith('"')) {
                    localStorage.setItem('mdbook-sidebar', sidebar.slice(1, sidebar.length - 1));
                }
            } catch (e) { }
        </script>

        <!-- Set the theme before any content is loaded, prevents flash -->
        <script type="text/javascript">
            var theme;
            try { theme = localStorage.getItem('mdbook-theme'); } catch(e) { } 
            if (theme === null || theme === undefined) { theme = 'light'; }
            document.body.className = theme;
            document.querySelector('html').className = theme;
        </script>

        <!-- Hide / unhide sidebar before it is displayed -->
        <script type="text/javascript">
            var html = document.querySelector('html');
            var sidebar = 'hidden';
            if (document.body.clientWidth >= 1080) {
                try { sidebar = localStorage.getItem('mdbook-sidebar'); } catch(e) { }
                sidebar = sidebar || 'visible';
            }
            html.classList.remove('sidebar-visible');
            html.classList.add("sidebar-" + sidebar);
        </script>

        <nav id="sidebar" class="sidebar" aria-label="Table of contents">
            <ol class="chapter"><li class="affix"><a href="intro.html">Introduction</a></li><li><a href="finger_thinking.html"><strong aria-hidden="true">1.</strong> Part 1</a></li><li><ol class="section"><li><a href="lesson0.run.html"><strong aria-hidden="true">1.1.</strong> Setup</a></li><li><a href="lesson1.run.html"><strong aria-hidden="true">1.2.</strong> Lesson 1</a></li><li><a href="lesson2.run.html"><strong aria-hidden="true">1.3.</strong> Lesson 2</a></li><li><a href="lesson3.run.html"><strong aria-hidden="true">1.4.</strong> Lesson 3</a></li><li><a href="lesson4.run.html"><strong aria-hidden="true">1.5.</strong> Lesson 4</a></li><li><a href="lesson5.run.html"><strong aria-hidden="true">1.6.</strong> Lesson 5</a></li><li><a href="lesson6.run.html"><strong aria-hidden="true">1.7.</strong> Lesson 6</a></li><li><a href="lesson7.run.html"><strong aria-hidden="true">1.8.</strong> Lesson 7</a></li><li><a href="lesson8.run.html"><strong aria-hidden="true">1.9.</strong> Lesson 8</a></li><li><a href="lesson9.run.html"><strong aria-hidden="true">1.10.</strong> Lesson 9</a></li><li><a href="lesson10.run.html" class="active"><strong aria-hidden="true">1.11.</strong> Lesson 10</a></li><li><a href="lesson11.run.html"><strong aria-hidden="true">1.12.</strong> Lesson 11</a></li><li><a href="recap.html"><strong aria-hidden="true">1.13.</strong> Recapitulation</a></li></ol></li><li><a href="code.html"><strong aria-hidden="true">2.</strong> Code Listings</a></li><li><ol class="section"><li><a href="original.run.html"><strong aria-hidden="true">2.1.</strong> Original Code</a></li><li><a href="lesson1.py.run.html"><strong aria-hidden="true">2.2.</strong> part 1, lesson1</a></li><li><a href="lesson2.py.run.html"><strong aria-hidden="true">2.3.</strong> part 1, lesson2</a></li><li><a href="lesson3.py.run.html"><strong aria-hidden="true">2.4.</strong> part 1, lesson3</a></li><li><a href="lesson4.py.run.html"><strong aria-hidden="true">2.5.</strong> part 1, lesson4</a></li><li><a href="lesson5.py.run.html"><strong aria-hidden="true">2.6.</strong> part 1, lesson5</a></li><li><a href="lesson6.py.run.html"><strong aria-hidden="true">2.7.</strong> part 1, lesson6</a></li><li><a href="lesson7.py.run.html"><strong aria-hidden="true">2.8.</strong> part 1, lesson7</a></li><li><a href="lesson8.py.run.html"><strong aria-hidden="true">2.9.</strong> part 1, lesson8</a></li><li><a href="lesson9.py.run.html"><strong aria-hidden="true">2.10.</strong> part 1, lesson9</a></li><li><a href="lesson10.py.run.html"><strong aria-hidden="true">2.11.</strong> part 1, lesson10</a></li><li><a href="lesson11.py.run.html"><strong aria-hidden="true">2.12.</strong> part 1, lesson11</a></li></ol></li><li><a href="dependencies.html">Dependencies</a></li></ol>
        </nav>

        <div id="page-wrapper" class="page-wrapper">

            <div class="page">
                
                <div id="menu-bar" class="menu-bar">
                    <div id="menu-bar-sticky-container">
                        <div class="left-buttons javascript-only">
                            <button id="sidebar-toggle" class="icon-button" type="button" title="Toggle Table of Contents" aria-label="Toggle Table of Contents" aria-controls="sidebar">
                                <i class="fa fa-bars"></i>
                            </button>
                            <button id="theme-toggle" class="icon-button" type="button" title="Change theme" aria-label="Change theme" aria-haspopup="true" aria-expanded="false" aria-controls="theme-list">
                                <i class="fa fa-paint-brush"></i>
                            </button>
                            <ul id="theme-list" class="theme-popup" aria-label="Themes" role="menu">
                                <li role="none"><button role="menuitem" class="theme" id="light">Light <span class="default">(default)</span></button></li>
                                <li role="none"><button role="menuitem" class="theme" id="rust">Rust</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="coal">Coal</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="navy">Navy</button></li>
                                <li role="none"><button role="menuitem" class="theme" id="ayu">Ayu</button></li>
                            </ul>
                            
                            <button id="search-toggle" class="icon-button" type="button" title="Search. (Shortkey: s)" aria-label="Toggle Searchbar" aria-expanded="false" aria-keyshortcuts="S" aria-controls="searchbar">
                                <i class="fa fa-search"></i>
                            </button>
                            
                        </div>

                        <h1 class="menu-title">BOXES (WIP title)</h1> 

                        <div class="right-buttons">
                            <a href="print.html" title="Print this book" aria-label="Print this book">
                                <i id="print-button" class="fa fa-print"></i>
                            </a>
                        </div>
                    </div>
                </div>

                
                <div id="searchbar-outer" class="searchbar-outer">
                    <input type="search" id="searchbar" name="searchbar" placeholder="Search this book ..." aria-controls="searchresults-outer" aria-describedby="searchresults-header">
                </div>
                <div id="searchresults-outer" class="searchresults-outer">
                    <div class="searchresults-header" id="searchresults-header"></div>
                    <ul id="searchresults">
                    </ul>
                </div>
                

                <!-- Apply ARIA attributes after the sidebar and the sidebar toggle button are added to the DOM -->
                <script type="text/javascript">
                    document.getElementById('sidebar-toggle').setAttribute('aria-expanded', sidebar === 'visible');
                    document.getElementById('sidebar').setAttribute('aria-hidden', sidebar !== 'visible');
                    Array.from(document.querySelectorAll('#sidebar a')).forEach(function(link) {
                        link.setAttribute('tabIndex', sidebar === 'visible' ? 0 : -1);
                    });
                </script>

                <div id="content" class="content">
                    <main>
                        <a class="header" href="lesson10.run.html#boxes-v10" id="boxes-v10"><h1>BOXES v10</h1></a>
<p>In our <a href="lesson9.run.html">previous lesson</a> we created a serviceable text layout engine. It has many problems, but remember our goal is not to create the best possible thing, this is an educational experience. The spit and polish will appear later on.</p>
<p>But there is a glaring problem, it breaks words in all the wrong places. Examples of it appear in almost every line of the output. So, how does one
fix that?</p>
<p>The traditional answer (and the one we will be using) is hyphenation, breaking
words between lines in the correct places.</p>
<p>Instead of breaking anywhere, we will break only in the places where the <a href="https://english.stackexchange.com/questions/385/what-are-the-rules-for-splitting-words-at-the-end-of-a-line">rules of each language</a>
allow us to.</p>
<p>Just as it happened with <a href="lesson7.run.html">text shaping</a> we are lucky to live
in a moment in time when almost everything we need to do it right is already
in place. In particular, we will use a library called
<a href="https://github.com/Kozea/Pyphen">Pyphen</a> mostly because I already have
used it in another project.</p>
<p>Am I sure it's the best one? No. Do I know exactly how it does what it does? No. I know enough to make
it work, and it works <em>well enough</em> so for this stage in the life of this project that is more than
enough. In fact, it takes the rules for word-breaking from dictionaries provided by an Office Suite,
so it does about as good a job as the dictionary does. It even supports subtleties such as the
differences betwen British and American English!</p>
<p>Here's an example of how it works:</p>
<pre><code class="language-python">import pyphen
dic = pyphen.Pyphen(lang='en_GB')
print('en_GB:', dic.inserted('dictionary', '-'))
dic = pyphen.Pyphen(lang='en_US')
print('en_US:', dic.inserted('dictionary', '-'))
</code></pre>
<pre><code>en_GB: dic-tion-ary
en_US: dic-tio-nary
</code></pre>
<p>Keep in mind that this is not magic. If you feed it garbage, it
will give you garbage.</p>
<pre><code class="language-python">dic = pyphen.Pyphen(lang='es_ES')
print('es_ES:', dic.inserted('dictionary', '-'))
</code></pre>
<pre><code>es_ES: dic-tio-na-ry
</code></pre>
<p>Where is it proper to break a line?</p>
<ul>
<li>On a newline character</li>
<li>On a space</li>
<li>On a breaking point as defined by Pyphen</li>
</ul>
<p>One of those things is not like the others. We have boxes with newlines in them and we have boxes with spaces in them, but there are no boxes with breaking points in them.</p>
<p>But we can add them! There is unicode symbol for that:</p>
<blockquote>
<a class="header" href="lesson10.run.html#soft-hyphen-shy" id="soft-hyphen-shy"><h3>SOFT HYPHEN (SHY)</h3></a>
<p>The <a href="https://en.wikipedia.org/wiki/Soft_hyphen">soft hyphen</a> serves as an invisible marker used to specify a place in text where a hyphenated break is allowed without forcing a line break in an inconvenient place if the text is re-flowed. It becomes visible only after word wrapping at the end of a line.</p>
</blockquote>
<p>So, if we insert them in all the right places, then we can use them to decide whether we are at a suitable breaking point. We will put this in a file called
<code>hyphen.py</code></p>
<pre><code class="language-python"># hyphen.py
import pyphen

dic = pyphen.Pyphen(lang='en_US')


def insert_soft_hyphens(text, hyphen='\xad'):
    &quot;&quot;&quot;Insert the hyphen in breaking pointsaccording to the dictionary.
    
    '\xad' is the Soft Hyphen (SHY) character
    &quot;&quot;&quot;
    lines = []
    for line in text.splitlines():
        hyph_words = [
            dic.inserted(word, hyphen) for word in line.split()
        ]
        lines.append(' '.join(hyph_words))
    return '\n'.join(lines)

</code></pre>
<pre><code class="language-python">from code.hyphen import insert_soft_hyphens

print (insert_soft_hyphens('Roses are red\nViolets are blue', '-'))
</code></pre>
<pre><code>Ros-es are red
Vi-o-lets are blue
</code></pre>
<p>So, with this code ready, we can get to work on implementing hyphenation support in our layout function.</p>
<p>First, this code is exactly as it was before:</p>
<pre><code class="language-python"># lesson10.py
from code.fonts import adjust_widths_by_letter
from code.hyphen import insert_soft_hyphens


class Box():

    def __init__(self, x=0, y=0, w=1, h=1, stretchy=False, letter='x'):
        &quot;&quot;&quot;Accept arguments to define our box, and store them.&quot;&quot;&quot;
        self.x = x
        self.y = y
        self.w = w
        self.h = h
        self.stretchy = stretchy
        self.letter = letter

    def __repr__(self):
        return 'Box(%s, %s, %s, %s, &quot;%s&quot;)' % (
            self.x, self.y, self.w, self.y, self.letter
        )

</code></pre>
<p>We do need to make a small change to how we load our text, to add the hyphens:</p>
<pre><code class="language-python"># lesson10.py
p_and_p = open('pride-and-prejudice.txt').read()
p_and_p = insert_soft_hyphens(p_and_p)  # Insert invisible hyphens
text_boxes = []
for l in p_and_p:
    text_boxes.append(Box(letter=l, stretchy=l == ' '))
adjust_widths_by_letter(text_boxes)

# A few pages all the same size
pages = [Box(i * 35, 0, 30, 50) for i in range(10)]

</code></pre>
<p>No changes in how we draw things.</p>
<pre><code class="language-python"># lesson10.py
import svgwrite


def draw_boxes(boxes, fname, size, hide_boxes=False):
    dwg = svgwrite.Drawing(fname, profile='full', size=size)
    # Draw the pages
    for page in pages:
        dwg.add(
            dwg.rect(
                insert=(page.x, page.y),
                size=(page.w, page.h),
                fill='lightblue',
            )
        )
    # Draw all the boxes
    for box in boxes:
        # The box color depends on its features
        color = 'green' if box.stretchy else 'red'
        # Make the colored boxes optional
        if not hide_boxes:
            dwg.add(
                dwg.rect(
                    insert=(box.x, box.y),
                    size=(box.w, box.h),
                    fill=color,
                )
            )
        # Display the letter in the box
        if box.letter:
            dwg.add(
                dwg.text(
                    box.letter,
                    insert=(box.x, box.y + box.h),
                    font_size=box.h,
                    font_family='Arial',
                )
            )
    dwg.save()

</code></pre>
<p>And now our layout function. One first approach, which we will refine later,
is to simply refuse to break lines if we are not in a &quot;good&quot; place to break it.</p>
<p>Then, we inject a box with a visible hyphen in the linebreak, and that's it.</p>
<p>Here is the code to create a box with a hyphen:</p>
<pre><code class="language-python"># lesson10.py
def hyphenbox():
    b = Box(letter='-')
    adjust_widths_by_letter([b])
    return b

</code></pre>
<p>And here finally, our layout supports hyphens:</p>
<pre><code class="language-python"># lesson10.py
# We add a &quot;separation&quot; constant so you can see the boxes individually
separation = .05


def layout(_boxes):
    &quot;&quot;&quot;Layout boxes along pages.

    Keep in mind that this function modifies the boxes themselves, so
    you should be very careful about trying to call layout() more than once
    on the same boxes.

    Specifically, some spaces will become 0-width and not stretchy.
    &quot;&quot;&quot;

    # Because we modify the box list, we will work on a copy
    boxes = _boxes[:]
    # We start at page 0
    page = 0
    # The 1st box should be placed in the correct page
    previous = boxes.pop(0)
    previous.x = pages[page].x
    previous.y = pages[page].y
    row = []
    while boxes:
        # We take the new 1st box
        box = boxes.pop(0)
        # And put it next to the other
        box.x = previous.x + previous.w + separation
        # At the same vertical location
        box.y = previous.y

        # Handle breaking on newlines
        break_line = False
        # But if it's a newline
        if (box.letter == '\n'):
            break_line = True
            # Newlines take no horizontal space ever
            box.w = 0
            box.stretchy = False

        # Or if it's too far to the right, and is a
        # good place to break the line...
        elif (box.x + box.w) &gt; (
            pages[page].x + pages[page].w
        ) and box.letter in (
            ' ', '\xad'
        ):
            if box.letter == '\xad':
                # Add a visible hyphen in the row
                h_b = hyphenbox()
                h_b.x = previous.x + previous.w + separation
                h_b.y = previous.y
                _boxes.append(h_b)  # So it's drawn
                row.append(h_b)  # So it's justified
            break_line = True
            # We adjust the row
            # Remove all right-margin spaces
            while row[-1].letter == ' ':
                row.pop()
            slack = (pages[page].x + pages[page].w) - (
                row[-1].x + row[-1].w
            )
            # Get a list of all the ones that are stretchy
            stretchies = [b for b in row if b.stretchy]
            if not stretchies:  # Nothing stretches do as before.
                bump = slack / len(row)
                # The 1st box gets 0 bumps, the 2nd gets 1 and so on
                for i, b in enumerate(row):
                    b.x += bump * i
            else:
                bump = slack / len(stretchies)
                # Each stretchy gets wider
                for b in stretchies:
                    b.w += bump
                # And we put each thing next to the previous one
                for j, b in enumerate(row[1:], 1):
                    b.x = row[j - 1].x + row[j - 1].w + separation


        if break_line:
            # We start a new row
            row = []
            # We go all the way left and a little down
            box.x = pages[page].x
            box.y = previous.y + previous.h + separation

        # But if we go too far down
        if box.y + box.h &gt; pages[page].y + pages[page].h:
            # We go to the next page
            page += 1
            # And put the box at the top-left
            box.x = pages[page].x
            box.y = pages[page].y

        # Put the box in the row
        row.append(box)

        # Collapse all left-margin space
        if all(b.letter == ' ' for b in row):
            box.w = 0
            box.stretchy = False
            box.x = pages[page].x

        previous = box


layout(text_boxes)

</code></pre>
<pre><code class="language-python"># lesson10.py
draw_boxes(text_boxes, 'lesson10.svg', (30, 50), hide_boxes=True)

</code></pre>
<p><img src="lesson10.svg" alt="lesson10.svg" /></p>
<p>And there in &quot;proper-ty&quot; you can see it in action. Of course this is
a na√Øve implementation. What happens if you just can't break?</p>
<pre><code class="language-python">many_boxes = [Box(letter='a') for i in range(200)]
adjust_widths_by_letter(many_boxes)
layout(many_boxes)
draw_boxes(many_boxes, 'lesson10_lots_of_a.svg', (35, 6), hide_boxes=True)
</code></pre>
<p><img src="lesson10_lots_of_a.svg" alt="lesson10_lots_of_a.svg" /></p>
<p>Since it can't break at all, it just goes on and on.</p>
<p>And there are other corner cases!</p>
<pre><code class="language-python">many_boxes = [Box(letter='a') for i in range(200)]
many_boxes[100] = Box(letter=' ', stretchy=True)
adjust_widths_by_letter(many_boxes)
layout(many_boxes)
draw_boxes(many_boxes, 'lesson10_one_break.svg', (35, 6), hide_boxes=True)
</code></pre>
<p><img src="lesson10_one_break.svg" alt="lesson10_one_break.svg" /></p>
<p>Because there is only one place to break the line, it then tries to
wedge 100 letter &quot;a&quot; where there is room for 54 (I counted!) and something interesting happens... the &quot;slack&quot; is negative!</p>
<p>Instead of stretching out a &quot;underfilled&quot; line, we are squeezing a &quot;overfilled&quot; one. Everything gets packed too tight, and the letters start
overlapping one another.</p>
<p>The lesson is that just because it works for the usual case it doesn't mean
it's <strong>done</strong>. Even in the case of words, it can happen that breaking points take a while to appear and our line becomes overfull.</p>
<p>We will tackle that problem next.</p>
<hr />
<p>Further references:</p>
<ul>
<li>Full source code for this lesson <a href="lesson10.py.run.html">lesson10.py</a></li>
<li><a href="diffs/lesson9_lesson10.html">Difference with code from last lesson</a></li>
</ul>

                    </main>

                    <nav class="nav-wrapper" aria-label="Page navigation">
                        <!-- Mobile navigation buttons -->
                        
                            <a rel="prev" href="lesson9.run.html" class="mobile-nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                                <i class="fa fa-angle-left"></i>
                            </a>
                        

                        
                            <a rel="next" href="lesson11.run.html" class="mobile-nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                                <i class="fa fa-angle-right"></i>
                            </a>
                        

                        <div style="clear: both"></div>
                    </nav>
                </div>
            </div>

            <nav class="nav-wide-wrapper" aria-label="Page navigation">
                
                    <a href="lesson9.run.html" class="nav-chapters previous" title="Previous chapter" aria-label="Previous chapter" aria-keyshortcuts="Left">
                        <i class="fa fa-angle-left"></i>
                    </a>
                

                
                    <a href="lesson11.run.html" class="nav-chapters next" title="Next chapter" aria-label="Next chapter" aria-keyshortcuts="Right">
                        <i class="fa fa-angle-right"></i>
                    </a>
                
            </nav>

        </div>


        <!-- Local fallback for Font Awesome -->
        <script>
            if (getComputedStyle(document.querySelector(".fa")).fontFamily !== "FontAwesome") {
                var link = document.createElement('link');
                link.rel = 'stylesheet';
                link.type = 'text/css';
                link.href = '_FontAwesome/css/font-awesome.css';
                document.head.insertBefore(link, document.head.firstChild)
            }
        </script>

        

        

        

        
        <script src="searchindex.js" type="text/javascript" charset="utf-8"></script>
        
        
        <script src="elasticlunr.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="mark.min.js" type="text/javascript" charset="utf-8"></script>
        <script src="searcher.js" type="text/javascript" charset="utf-8"></script>
        

        

        <script src="highlight.js"></script>
        <script src="book.js"></script>

        <!-- Custom JS script -->
        

    </body>
</html>
